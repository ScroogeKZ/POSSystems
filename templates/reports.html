{% extends "base.html" %}

{% block title %}–ï—Å–µ–ø—Ç–µ—Ä / –û—Ç—á–µ—Ç—ã - POS –ñ“Ø–π–µ—Å—ñ{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">üìä –ï—Å–µ–ø—Ç–µ—Ä –º–µ–Ω —Ç–∞–ª–¥–∞—É–ª–∞—Ä / –û—Ç—á–µ—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üìÖ –ï—Å–µ–ø –∫–µ–∑–µ“£—ñ / –ü–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞</h5>
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">–ë–∞—Å—Ç–∞–ª—É –∫“Ø–Ω—ñ / –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞</label>
                            <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–ê—è“õ—Ç–∞–ª—É –∫“Ø–Ω—ñ / –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞</label>
                            <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–ï—Å–µ–ø —Ç“Ø—Ä—ñ / –¢–∏–ø –æ—Ç—á–µ—Ç–∞</label>
                            <select name="type" class="form-select">
                                <option value="overview" {% if report_type == 'overview' %}selected{% endif %}>–ñ–∞–ª–ø—ã / –û–±–∑–æ—Ä</option>
                                <option value="profit" {% if report_type == 'profit' %}selected{% endif %}>–ü–∞–π–¥–∞ / –ü—Ä–∏–±—ã–ª—å</option>
                                <option value="categories" {% if report_type == 'categories' %}selected{% endif %}>–°–∞–Ω–∞—Ç—Ç–∞—Ä / –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                <option value="inventory" {% if report_type == 'inventory' %}selected{% endif %}>“ö–æ–π–º–∞ / –°–∫–ª–∞–¥</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">üîÑ –ñ–∞“£–∞—Ä—Ç—É / –û–±–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                    </form>
                    <!-- Export Buttons -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <a href="/export/pdf?start_date={{ start_date }}&end_date={{ end_date }}" 
                               class="btn btn-danger w-100" target="_blank">
                                üìÑ PDF –∂“Ø–∫—Ç–µ—É / –°–∫–∞—á–∞—Ç—å PDF
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="/export/excel?start_date={{ start_date }}&end_date={{ end_date }}" 
                               class="btn btn-success w-100" target="_blank">
                                üìä Excel –∂“Ø–∫—Ç–µ—É / –°–∫–∞—á–∞—Ç—å Excel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>{{ "%.2f"|format(total_revenue or 0) }} ‚Ç∏</h3>
                    <p class="mb-1">üí∞ –ñ–∞–ª–ø—ã –∫—ñ—Ä—ñ—Å / –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</p>
                    <h4>{{ "%.2f"|format(total_profit or 0) }} ‚Ç∏</h4>
                    <p class="mb-1">üìà –ñ–∞–ª–ø—ã –ø–∞–π–¥–∞ / –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</p>
                    <small>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å / –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å: {{ "%.1f"|format(profit_margin or 0) }}%</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Revenue vs Profit Chart -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">üìä –ö—ñ—Ä—ñ—Å –ø–µ–Ω –ø–∞–π–¥–∞ –¥–∏–Ω–∞–º–∏–∫–∞—Å—ã / –î–∏–Ω–∞–º–∏–∫–∞ –≤—ã—Ä—É—á–∫–∏ –∏ –ø—Ä–∏–±—ã–ª–∏</h5>
                </div>
                <div class="card-body">
                    <canvas id="profitChart" height="100"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Category Distribution -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">ü•ß –°–∞–Ω–∞—Ç –±–æ–π—ã–Ω—à–∞ “Ø–ª–µ—Å—Ç—ñ—Ä—É / –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Tabs -->
    <ul class="nav nav-tabs mb-4" id="analyticsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                üìã –ñ–∞–ª–ø—ã / –û–±–∑–æ—Ä
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button">
                üèÜ –¢–æ–ø —Ç–∞—É–∞—Ä–ª–∞—Ä / –¢–æ–ø —Ç–æ–≤–∞—Ä—ã
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button">
                üìä –°–∞–Ω–∞—Ç—Ç–∞—Ä / –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button">
                üì¶ “ö–æ–π–º–∞ / –°–∫–ª–∞–¥
            </button>
        </li>
    </ul>

    <div class="tab-content" id="analyticsTabContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-info">{{ daily_sales|length }}</h4>
                            <p class="text-muted">–°–∞—É–¥–∞ –∫“Ø–Ω–¥–µ—Ä—ñ / –¢–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-success">{{ "%.0f"|format((total_revenue / daily_sales|length) if daily_sales|length > 0 else 0) }} ‚Ç∏</h4>
                            <p class="text-muted">–ö“Ø–Ω–¥—ñ–∫ –æ—Ä—Ç–∞—à–∞ –∫—ñ—Ä—ñ—Å / –°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ –≤ –¥–µ–Ω—å</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-warning">{{ "%.0f"|format((total_profit / daily_sales|length) if daily_sales|length > 0 else 0) }} ‚Ç∏</h4>
                            <p class="text-muted">–ö“Ø–Ω–¥—ñ–∫ –æ—Ä—Ç–∞—à–∞ –ø–∞–π–¥–∞ / –°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å –≤ –¥–µ–Ω—å</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-danger">{{ low_stock_items|length }}</h4>
                            <p class="text-muted">–ê–∑ “õ–∞–ª–¥—ã / –ó–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Products Tab -->
        <div class="tab-pane fade" id="products" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">üèÜ –°–∞—Ç—É–ª–∞—Ä –±–æ–π—ã–Ω—à–∞ —Ç–æ–ø —Ç–∞—É–∞—Ä–ª–∞—Ä / –¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º</h5>
                </div>
                <div class="card-body">
                    {% if top_products %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>üì¶ –¢–∞—É–∞—Ä / –¢–æ–≤–∞—Ä</th>
                                        <th>üìä –°–∞—Ç—ã–ª–¥—ã / –ü—Ä–æ–¥–∞–Ω–æ</th>
                                        <th>üí∞ –ö—ñ—Ä—ñ—Å / –í—ã—Ä—É—á–∫–∞</th>
                                        <th>üìà –ü–∞–π–¥–∞ / –ü—Ä–∏–±—ã–ª—å</th>
                                        <th>üí° –ë—ñ—Ä–ª—ñ–∫ –ø–∞–π–¥–∞—Å—ã / –ü—Ä–∏–±—ã–ª—å –∑–∞ –µ–¥.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in top_products %}
                                    <tr>
                                        <td><strong>{{ product.name }}</strong></td>
                                        <td><span class="badge bg-info">{{ "%.0f"|format(product.total_sold) }}</span></td>
                                        <td>{{ "%.2f"|format(product.total_revenue) }} ‚Ç∏</td>
                                        <td><span class="text-success">{{ "%.2f"|format(product.total_profit or 0) }} ‚Ç∏</span></td>
                                        <td><span class="text-warning">{{ "%.2f"|format(product.avg_profit_per_unit or 0) }} ‚Ç∏</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">üì≠ –¢–∞“£–¥–∞–ª“ì–∞–Ω –∫–µ–∑–µ“£ “Ø—à—ñ–Ω –¥–µ—Ä–µ–∫—Ç–µ—Ä –∂–æ“õ / –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div class="tab-pane fade" id="categories" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">üìä –°–∞–Ω–∞—Ç –±–æ–π—ã–Ω—à–∞ —Ç–∞–ª–¥–∞—É / –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h5>
                </div>
                <div class="card-body">
                    {% if category_analysis %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>üìÇ –°–∞–Ω–∞—Ç / –ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                        <th>üõí –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä / –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</th>
                                        <th>üì¶ –°–∞—Ç—ã–ª–¥—ã / –ü—Ä–æ–¥–∞–Ω–æ</th>
                                        <th>üí∞ –ö—ñ—Ä—ñ—Å / –í—ã—Ä—É—á–∫–∞</th>
                                        <th>üìà –ü–∞–π–¥–∞ / –ü—Ä–∏–±—ã–ª—å</th>
                                        <th>üìä –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for category in category_analysis %}
                                    {% set profit_margin = (category.total_profit / category.total_revenue * 100) if category.total_revenue > 0 else 0 %}
                                    <tr>
                                        <td><strong>{{ category.name }}</strong></td>
                                        <td><span class="badge bg-primary">{{ category.total_transactions }}</span></td>
                                        <td>{{ "%.0f"|format(category.total_sold) }}</td>
                                        <td>{{ "%.2f"|format(category.total_revenue) }} ‚Ç∏</td>
                                        <td><span class="text-success">{{ "%.2f"|format(category.total_profit or 0) }} ‚Ç∏</span></td>
                                        <td>
                                            <span class="badge {% if profit_margin > 20 %}bg-success{% elif profit_margin > 10 %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ "%.1f"|format(profit_margin) }}%
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">üì≠ –°–∞–Ω–∞—Ç –±–æ–π—ã–Ω—à–∞ –¥–µ—Ä–µ–∫—Ç–µ—Ä –∂–æ“õ / –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div class="tab-pane fade" id="inventory" role="tabpanel">
            <div class="row">
                <!-- Low Stock Alert -->
                {% if low_stock_items %}
                <div class="col-12 mb-4">
                    <div class="alert alert-warning">
                        <h6>‚ö†Ô∏è –ê–∑ “õ–∞–ª“ì–∞–Ω —Ç–∞—É–∞—Ä–ª–∞—Ä / –ó–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è —Ç–æ–≤–∞—Ä—ã ({{ low_stock_items|length }})</h6>
                        <div class="row">
                            {% for item in low_stock_items[:6] %}
                            <div class="col-md-4 col-lg-2">
                                <small><strong>{{ item.name }}</strong><br>
                                “ö–∞–ª–¥—ã / –û—Å—Ç–∞—Ç–æ–∫: {{ item.stock_quantity }} {{ item.sku }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                        {% if low_stock_items|length > 6 %}
                        <small class="text-muted">... –∂”ô–Ω–µ —Ç–∞“ì—ã {{ low_stock_items|length - 6 }} —Ç–∞—É–∞—Ä / ... –∏ –µ—â–µ {{ low_stock_items|length - 6 }} —Ç–æ–≤–∞—Ä–æ–≤</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Inventory Table -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">üì¶ “ö–æ–π–º–∞ –µ—Å–µ–±—ñ / –°–∫–ª–∞–¥—Å–∫–æ–π –æ—Ç—á–µ—Ç</h5>
                            <small class="text-muted">–ñ–∞–ª–ø—ã —Ç–∞—É–∞—Ä–ª–∞—Ä / –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: {{ inventory_report|length }}</small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="inventoryTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>üì¶ –¢–∞—É–∞—Ä / –¢–æ–≤–∞—Ä</th>
                                            <th>üè∑Ô∏è –ê—Ä—Ç–∏–∫—É–ª</th>
                                            <th>üìä “ö–∞–ª–¥—ã / –û—Å—Ç–∞—Ç–æ–∫</th>
                                            <th>‚ö†Ô∏è –ú–∏–Ω. –¥–µ“£–≥–µ–π / –ú–∏–Ω. —É—Ä–æ–≤–µ–Ω—å</th>
                                            <th>üí∞ –ë–∞“ì–∞ / –¶–µ–Ω–∞</th>
                                            <th>üìà –ü–∞–π–¥–∞ / –ü—Ä–∏–±—ã–ª—å</th>
                                            <th>üìÇ –°–∞–Ω–∞—Ç / –ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                            <th>üè™ –ñ–µ—Ç–∫—ñ–∑—É—à—ñ / –ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in inventory_report %}
                                        <tr {% if item.stock_quantity <= item.min_stock_level %}class="table-warning"{% endif %}>
                                            <td><strong>{{ item.name }}</strong></td>
                                            <td><code>{{ item.sku }}</code></td>
                                            <td>
                                                <span class="badge {% if item.stock_quantity <= item.min_stock_level %}bg-danger{% elif item.stock_quantity <= item.min_stock_level * 2 %}bg-warning{% else %}bg-success{% endif %}">
                                                    {{ item.stock_quantity }}
                                                </span>
                                            </td>
                                            <td>{{ item.min_stock_level }}</td>
                                            <td>{{ "%.2f"|format(item.price) }} ‚Ç∏</td>
                                            <td>{{ "%.2f"|format(item.price - item.cost_price) }} ‚Ç∏</td>
                                            <td><small>{{ item.category_name }}</small></td>
                                            <td><small>{{ item.supplier_name }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Revenue vs Profit Chart
const profitCtx = document.getElementById('profitChart').getContext('2d');
const dailySalesData = {{ daily_sales|tojson|safe }};

new Chart(profitCtx, {
    type: 'line',
    data: {
        labels: dailySalesData.map(sale => new Date(sale.date).toLocaleDateString('ru-RU')),
        datasets: [{
            label: '–ö—ñ—Ä—ñ—Å / –í—ã—Ä—É—á–∫–∞ (‚Ç∏)',
            data: dailySalesData.map(sale => sale.total_revenue || 0),
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.1,
            fill: false
        }, {
            label: '–ü–∞–π–¥–∞ / –ü—Ä–∏–±—ã–ª—å (‚Ç∏)',
            data: dailySalesData.map(sale => sale.total_profit || 0),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.1,
            fill: false
        }]
    },
    options: {
        responsive: true,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString() + ' ‚Ç∏';
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' ‚Ç∏';
                    }
                }
            }
        }
    }
});

// Category Distribution Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryData = {{ category_analysis|tojson|safe }};

new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: categoryData.map(cat => cat.name),
        datasets: [{
            data: categoryData.map(cat => cat.total_revenue || 0),
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40',
                '#FF6384',
                '#C9CBCF'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    boxWidth: 12,
                    fontSize: 11
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed * 100) / total).toFixed(1);
                        return context.label + ': ' + context.parsed.toLocaleString() + ' ‚Ç∏ (' + percentage + '%)';
                    }
                }
            }
        }
    }
});

// Initialize DataTable for inventory if available
if (typeof $.fn.DataTable !== 'undefined') {
    $('#inventoryTable').DataTable({
        pageLength: 25,
        order: [[2, 'asc']], // Sort by stock quantity
        language: {
            search: "–Ü–∑–¥–µ—É / –ü–æ–∏—Å–∫:",
            lengthMenu: "–ö”©—Ä—Å–µ—Ç—É / –ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∂–∞–∑–±–∞–ª–∞—Ä",
            info: "_START_ - _END_ of _TOTAL_ –∂–∞–∑–±–∞–ª–∞—Ä",
            paginate: {
                first: "–ê–ª“ì–∞—à“õ—ã",
                previous: "–ê—Ä—Ç“õ–∞",
                next: "–ö–µ–ª–µ—Å—ñ", 
                last: "–°–æ“£“ì—ã"
            }
        }
    });
}
</script>
{% endblock %}