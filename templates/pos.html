{% extends "base.html" %}

{% block title %}{{ get_text('Кассалық бөлім', 'Касса') }} - {{ get_text('POS Жүйесі', 'POS Система') }}{% endblock %}

{% block content %}
<div class="modern-pos-interface">
    <div class="container-fluid">
        <div class="row h-100">
            <!-- Left Panel - Product Search -->
            <div class="col-lg-6 search-panel">
                <div class="search-header">
                    <h4>{{ get_text('Тауарларды іздеу', 'Поиск товаров') }}</h4>
                </div>
                
                <div class="search-controls">
                    <div class="row g-3">
                        <div class="col-8">
                            <input type="text" id="productSearch" class="form-control form-control-lg" 
                                   placeholder="{{ get_text('Тауар атауын немесе артикулын енгізіңіз...', 'Введите название товара или артикул...') }}" autocomplete="off">
                        </div>
                        <div class="col-4">
                            <select id="categoryFilter" class="form-select form-select-lg">
                                <option value="">{{ get_text('Барлық санаттар', 'Все категории') }}</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.translated_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Quick Access and Scanner Controls -->
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="quick-access-controls">
                                <button id="toggleQuickAccess" class="btn btn-outline-success w-100">
                                    <i class="fas fa-star me-2"></i>
                                    <span>{{ get_text('Танымал тауарлар', 'Популярные товары') }}</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="barcode-scanner-controls">
                                <button id="toggleBarcodeScanner" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-qrcode me-2"></i>
                                    <span id="scannerButtonText">{{ get_text('Сканер қосу', 'Включить сканер') }}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Barcode Scanner Modal -->
                <div class="modal fade" id="barcodeScannerModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-qrcode me-2"></i>
                                    {{ get_text('Штрих-код сканері', 'Сканер штрих-кодов') }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="barcodeScanner" class="barcode-scanner-container">
                                    <div class="scanner-viewport">
                                        <video id="barcodeScannerVideo" autoplay muted playsinline></video>
                                        <div class="scanner-overlay">
                                            <div class="scanner-line"></div>
                                        </div>
                                    </div>
                                    <div class="scanner-info mt-3">
                                        <p class="text-center text-muted">
                                            {{ get_text('Штрих-кодты камера көрінісіне орналастырыңыз', 'Наведите штрих-код на камеру') }}
                                        </p>
                                        <div id="scannerStatus" class="text-center">
                                            <span class="badge bg-info">{{ get_text('Дайын', 'Готов к сканированию') }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div id="manualBarcodeInput" class="mt-3" style="display: none;">
                                    <div class="input-group">
                                        <input type="text" id="manualBarcode" class="form-control" 
                                               placeholder="{{ get_text('Штрих-кодты қолмен енгізіңіз', 'Введите штрих-код вручную') }}">
                                        <button type="button" id="submitManualBarcode" class="btn btn-primary">
                                            {{ get_text('Іздеу', 'Найти') }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" id="toggleManualInput" class="btn btn-outline-secondary">
                                    {{ get_text('Қолмен енгізу', 'Ручной ввод') }}
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    {{ get_text('Жабу', 'Закрыть') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Access Panel -->
                <div id="quickAccessPanel" class="quick-access-panel mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-star text-warning me-2"></i>
                                {{ get_text('Танымал тауарлар', 'Популярные товары') }}
                            </h6>
                            <small class="text-muted">{{ get_text('Жылдам қосу', 'Быстрое добавление') }}</small>
                        </div>
                        <div class="card-body p-2">
                            <div id="quickAccessProducts" class="row g-2">
                                <!-- Quick access products will be loaded here -->
                                <div class="col-12 text-center py-3">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    {{ get_text('Танымал тауарлар жүктелуде...', 'Загрузка популярных товаров...') }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="searchResults" class="search-results mt-3"></div>
            </div>

            <!-- Right Panel - Transaction & Payment -->
            <div class="col-lg-6 transaction-panel">
                <!-- Transaction Header -->
                <div class="transaction-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>{{ get_text('Чек', 'Транзакция') }}</h4>
                        <div class="d-flex align-items-center gap-2">
                            <!-- Sound Toggle Button -->
                            <button type="button" id="toggleSoundBtn" class="btn btn-outline-secondary btn-sm" title="Выключить звук">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <div id="transactionInfo" style="display: none;">
                                <span class="badge bg-primary fs-6" id="transactionNumber"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Items -->
                <div class="transaction-items">
                    <div class="items-header">
                        <div class="row fw-bold text-muted small">
                            <div class="col-5">ТОВАР</div>
                            <div class="col-2 text-center">КОЛ.</div>
                            <div class="col-2 text-end">ЦЕНА</div>
                            <div class="col-2 text-end">СУММА</div>
                            <div class="col-1"></div>
                        </div>
                    </div>
                    
                    <div id="cartItems" class="items-list">
                        <div class="empty-cart">
                            <p class="text-muted text-center py-5">
                                <i class="fas fa-shopping-cart fa-3x mb-3"></i><br>
                                Корзина пуста<br>
                                <small>Добавьте товары для начала продажи</small>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="payment-section">
                    <!-- Totals Display -->
                    <div class="totals-display">
                        <div class="d-flex justify-content-between">
                            <span>Подитог:</span>
                            <span id="subtotal">0.00 ₸</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>НДС (12%):</span>
                            <span id="taxAmount">0.00 ₸</span>
                        </div>
                        <div class="d-flex justify-content-between" id="discountRow" style="display: none;">
                            <span>Скидка:</span>
                            <span id="discountAmount" class="text-success">-0.00 ₸</span>
                        </div>
                        <div class="total-amount">
                            <div class="d-flex justify-content-between">
                                <span>ИТОГО:</span>
                                <span id="totalAmount">0.00 ₸</span>
                            </div>
                        </div>
                    </div>

                    <!-- Discount Section -->
                    <div id="discountSection" class="discount-section" style="display: none;">
                        <div class="card border-0 bg-light">
                            <div class="card-body p-3">
                                <h6 class="card-title">
                                    <i class="fas fa-percentage me-2"></i>Скидки и промокоды
                                </h6>
                                
                                <!-- Promo Code Input -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="text" id="promoCodeInput" class="form-control" 
                                               placeholder="Введите промокод" maxlength="20">
                                        <button id="applyPromoCode" class="btn btn-outline-primary">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                    <div id="promoCodeFeedback" class="mt-1" style="display: none;"></div>
                                </div>
                                
                                <!-- Quick Discount Buttons -->
                                <div class="row g-2">
                                    <div class="col-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="applyQuickDiscount(5, 'percentage')">
                                            5%
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="applyQuickDiscount(10, 'percentage')">
                                            10%
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="applyQuickDiscount(15, 'percentage')">
                                            15%
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Manual Discount -->
                                <div class="mt-3">
                                    <div class="input-group">
                                        <input type="number" id="customDiscountValue" class="form-control" 
                                               placeholder="Сумма скидки" min="0" step="0.01">
                                        <select id="customDiscountType" class="form-select" style="max-width: 100px;">
                                            <option value="percentage">%</option>
                                            <option value="fixed_amount">₸</option>
                                        </select>
                                        <button id="applyCustomDiscount" class="btn btn-outline-primary">
                                            Применить
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Remove Discount -->
                                <div class="mt-2" id="removeDiscountBtn" style="display: none;">
                                    <button class="btn btn-outline-danger btn-sm w-100" onclick="removeDiscount()">
                                        <i class="fas fa-times me-2"></i>Убрать скидку
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <button id="showSuspendedBtn" class="btn btn-outline-info w-100">
                                    <i class="fas fa-history me-2"></i>Отложенные
                                </button>
                            </div>
                            <div class="col-6">
                                <button id="startTransaction" class="btn btn-start">
                                    <i class="fas fa-play me-2"></i>Начать продажу
                                </button>
                            </div>
                        </div>
                        
                        <div id="transactionActions" style="display: none;">
                            <div class="row g-2 mb-3">
                                <div class="col-4">
                                    <button id="suspendTransaction" class="btn btn-secondary w-100">
                                        <i class="fas fa-pause me-2"></i>Отложить
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button id="discountBtn" class="btn btn-outline-success w-100">
                                        <i class="fas fa-percentage me-2"></i>Скидка
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button id="clearCart" class="btn btn-outline-danger w-100">
                                        <i class="fas fa-trash me-2"></i>Очистить
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Payment Methods -->
                            <div class="payment-methods">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <button id="cashPaymentBtn" class="btn btn-payment btn-cash w-100">
                                            <i class="fas fa-money-bill-wave mb-2"></i><br>
                                            <span>Наличные</span>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button id="cardPaymentBtn" class="btn btn-payment btn-card w-100">
                                            <i class="fas fa-credit-card mb-2"></i><br>
                                            <span>Карта</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- QuaggaJS - Barcode Scanner Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script>
// POS JavaScript functionality
let currentTransaction = null;
let cart = [];
let barcodeScanner = null;
let isScanning = false;

// Barcode Scanner functionality
class BarcodeScanner {
    constructor() {
        this.modal = document.getElementById('barcodeScannerModal');
        this.video = document.getElementById('barcodeScannerVideo');
        this.toggleBtn = document.getElementById('toggleBarcodeScanner');
        this.statusElement = document.getElementById('scannerStatus');
        this.manualInput = document.getElementById('manualBarcodeInput');
        this.manualBarcodeInput = document.getElementById('manualBarcode');
        
        this.setupEventListeners();
        this.stream = null;
    }
    
    setupEventListeners() {
        // Toggle scanner button
        this.toggleBtn.addEventListener('click', () => {
            this.openScanner();
        });
        
        // Manual input toggle
        document.getElementById('toggleManualInput').addEventListener('click', () => {
            this.toggleManualInput();
        });
        
        // Manual barcode submission
        document.getElementById('submitManualBarcode').addEventListener('click', () => {
            this.processManualBarcode();
        });
        
        this.manualBarcodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.processManualBarcode();
            }
        });
        
        // Modal close event
        this.modal.addEventListener('hidden.bs.modal', () => {
            this.stopScanner();
        });
    }
    
    async openScanner() {
        try {
            const modal = new bootstrap.Modal(this.modal);
            modal.show();
            
            // Start camera after modal is shown
            this.modal.addEventListener('shown.bs.modal', () => {
                this.startCamera();
            }, { once: true });
            
        } catch (error) {
            console.error('Error opening scanner:', error);
            this.updateStatus('Ошибка доступа к камере', 'danger');
        }
    }
    
    async startCamera() {
        try {
            this.updateStatus('Инициализация камеры...', 'warning');
            
            // Get camera stream
            this.stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment', // Use back camera on mobile
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            });
            
            this.video.srcObject = this.stream;
            
            // Initialize Quagga scanner
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: this.video
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 2,
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ]
                },
                locate: true
            }, (err) => {
                if (err) {
                    console.error('QuaggaJS initialization error:', err);
                    this.updateStatus('Ошибка инициализации сканера', 'danger');
                    return;
                }
                
                this.updateStatus('Готов к сканированию', 'success');
                Quagga.start();
                isScanning = true;
                
                // Listen for barcode detection
                Quagga.onDetected(this.onBarcodeDetected.bind(this));
            });
            
        } catch (error) {
            console.error('Camera access error:', error);
            this.updateStatus('Нет доступа к камере', 'danger');
        }
    }
    
    onBarcodeDetected(data) {
        const code = data.codeResult.code;
        
        // Add visual feedback
        const scanner = document.querySelector('.scanner-viewport');
        scanner.classList.add('scanner-success');
        setTimeout(() => scanner.classList.remove('scanner-success'), 300);
        
        this.updateStatus(`Найден: ${code}`, 'success');
        
        // Process the barcode
        this.searchProductByBarcode(code);
        
        // Close scanner after successful scan
        setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(this.modal);
            modal.hide();
        }, 1000);
    }
    
    stopScanner() {
        if (isScanning) {
            Quagga.stop();
            isScanning = false;
        }
        
        if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
            this.stream = null;
        }
        
        this.video.srcObject = null;
        this.updateStatus('Готов к сканированию', 'info');
    }
    
    toggleManualInput() {
        const isVisible = this.manualInput.style.display !== 'none';
        this.manualInput.style.display = isVisible ? 'none' : 'block';
        
        if (!isVisible) {
            this.manualBarcodeInput.focus();
        }
    }
    
    processManualBarcode() {
        const barcode = this.manualBarcodeInput.value.trim();
        if (barcode) {
            this.searchProductByBarcode(barcode);
            this.manualBarcodeInput.value = '';
            
            const modal = bootstrap.Modal.getInstance(this.modal);
            modal.hide();
        }
    }
    
    async searchProductByBarcode(barcode) {
        try {
            this.updateStatus('Поиск товара...', 'warning');
            
            const response = await fetch(`/api/search-barcode?code=${encodeURIComponent(barcode)}`);
            const data = await response.json();
            
            if (data.success && data.product) {
                // Воспроизводим звук успешного сканирования
                window.posSound && window.posSound.successBeep();
                
                // Add product to search results
                displaySearchResults([data.product]);
                this.updateStatus(`Товар найден: ${data.product.name}`, 'success');
                
                // Auto-add to cart if transaction is active
                if (currentTransaction) {
                    addToCart(data.product);
                }
            } else {
                // Воспроизводим звук ошибки сканирования
                window.posSound && window.posSound.errorBeep();
                this.updateStatus('Товар не найден', 'warning');
                alert(`Товар с штрих-кодом ${barcode} не найден в базе данных.`);
            }
            
        } catch (error) {
            console.error('Barcode search error:', error);
            this.updateStatus('Ошибка поиска', 'danger');
            alert('Ошибка при поиске товара по штрих-коду.');
        }
    }
    
    updateStatus(message, type) {
        const statusClass = {
            'info': 'bg-info',
            'success': 'bg-success', 
            'warning': 'bg-warning text-dark',
            'danger': 'bg-danger'
        };
        
        this.statusElement.innerHTML = `<span class="badge ${statusClass[type] || 'bg-info'}">${message}</span>`;
    }
}

// Initialize POS interface and barcode scanner when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    barcodeScanner = new BarcodeScanner();
});

function initializeEventListeners() {
    // Product search
    const searchInput = document.getElementById('productSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    
    searchInput.addEventListener('input', debounce(searchProducts, 300));
    categoryFilter.addEventListener('change', searchProducts);
    
    // Transaction actions
    document.getElementById('startTransaction').addEventListener('click', startNewTransaction);
    document.getElementById('clearCart').addEventListener('click', clearCart);
    document.getElementById('suspendTransaction').addEventListener('click', suspendTransaction);
    
    // Payment buttons
    document.getElementById('cashPaymentBtn').addEventListener('click', () => processPayment('cash'));
    document.getElementById('cardPaymentBtn').addEventListener('click', () => processPayment('card'));
    
    // Discount functionality
    document.getElementById('discountBtn').addEventListener('click', toggleDiscountSection);
    document.getElementById('applyPromoCode').addEventListener('click', applyPromoCode);
    document.getElementById('applyCustomDiscount').addEventListener('click', applyCustomDiscount);
    
    // Enter key for promo code
    document.getElementById('promoCodeInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyPromoCode();
        }
    });
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function searchProducts() {
    const query = document.getElementById('productSearch').value;
    const categoryId = document.getElementById('categoryFilter').value;
    
    if (query.length < 2 && !categoryId) {
        document.getElementById('searchResults').innerHTML = '';
        return;
    }
    
    try {
        const params = new URLSearchParams();
        if (query) params.append('q', query);
        if (categoryId) params.append('category_id', categoryId);
        
        const response = await fetch(`/api/products/search?${params}`);
        const products = await response.json();
        
        displaySearchResults(products);
    } catch (error) {
        console.error('Search error:', error);
    }
}

function displaySearchResults(products) {
    const resultsContainer = document.getElementById('searchResults');
    
    if (products.length === 0) {
        resultsContainer.innerHTML = '<p class="text-muted">Тауарлар табылмады / Товары не найдены</p>';
        return;
    }
    
    const html = products.map(product => `
        <div class="product-card card mb-2" data-product-id="${product.id}" data-product-name="${product.name.replace(/"/g, '&quot;')}" data-product-price="${product.price}" onclick="addToCartSafe(this)">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    ${product.image_filename ? `
                    <div class="col-2">
                        <img src="/static/images/products/thumbnails/${product.image_filename}" 
                             alt="${product.name}" 
                             class="img-thumbnail" 
                             style="width: 40px; height: 40px; object-fit: cover;">
                    </div>
                    <div class="col-6">
                    ` : `
                    <div class="col-8">
                    `}
                        <h6 class="card-title mb-1">${product.name}</h6>
                        <small class="text-muted">Артикул: ${product.sku}</small>
                    </div>
                    <div class="col-4 text-end">
                        <strong>${product.price.toFixed(2)} ₸</strong>
                        <br>
                        <small class="text-muted">На складе: ${product.stock_quantity} ${product.unit_type}</small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    resultsContainer.innerHTML = html;
}

async function startNewTransaction() {
    try {
        const response = await fetch('/api/transaction/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cashier_name: 'Кассир'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Короткий сигнал начала транзакции
            window.posSound && window.posSound.addItemBeep();
            
            currentTransaction = result;
            document.getElementById('transactionNumber').textContent = result.transaction_number;
            document.getElementById('transactionInfo').style.display = 'block';
            document.getElementById('startTransaction').style.display = 'none';
            document.getElementById('transactionActions').style.display = 'block';
        } else {
            window.posSound && window.posSound.errorBeep();
            alert('Ошибка создания транзакции: ' + result.error);
        }
    } catch (error) {
        console.error('Transaction start error:', error);
        alert('Ошибка связи с сервером');
    }
}

function addToCartSafe(element) {
    const productId = element.dataset.productId;
    const productName = element.dataset.productName;
    const price = parseFloat(element.dataset.productPrice);
    addToCart(parseInt(productId), productName, price);
}

async function addToCart(productId, productName, price) {
    if (!currentTransaction) {
        alert('Сначала начните новую продажу');
        return;
    }
    
    try {
        const response = await fetch('/api/transaction/add_item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: 1
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Воспроизводим звук успешного добавления товара
            window.posSound && window.posSound.addItemBeep();
            
            // Проверяем остатки для предупреждения
            if (result.product && result.product.stock_quantity <= 5) {
                window.posSound && window.posSound.warningBeep();
                showNotification(`Низкий остаток: ${result.product.name} (${result.product.stock_quantity} шт.)`, 'warning', 4000);
            }
            
            updateCartDisplay();
        } else {
            // Воспроизводим звук ошибки
            window.posSound && window.posSound.errorBeep();
            alert('Ошибка добавления товара: ' + result.error);
        }
    } catch (error) {
        console.error('Add to cart error:', error);
        alert('Ошибка связи с сервером');
    }
}

async function updateCartDisplay() {
    try {
        const response = await fetch('/api/transaction/current');
        const result = await response.json();
        
        if (result.success) {
            const transaction = result.transaction;
            const cartContainer = document.getElementById('cartItems');
            
            if (transaction.items.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-cart">
                        <p class="text-muted text-center py-5">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i><br>
                            Корзина пуста<br>
                            <small>Добавьте товары для начала продажи</small>
                        </p>
                    </div>
                `;
            } else {
                const itemsHtml = transaction.items.map(item => `
                    <div class="cart-item">
                        <div class="row align-items-center">
                            <div class="col-5">
                                <div class="fw-bold">${item.product_name}</div>
                                <small class="text-muted">${item.sku}</small>
                            </div>
                            <div class="col-2 text-center">
                                <span class="fw-bold">${item.quantity}</span>
                            </div>
                            <div class="col-2 text-end">
                                <span>${item.unit_price.toFixed(2)} ₸</span>
                            </div>
                            <div class="col-2 text-end">
                                <span class="fw-bold">${item.total_price.toFixed(2)} ₸</span>
                            </div>
                            <div class="col-1 text-end">
                                <button class="btn btn-outline-danger btn-sm" onclick="removeFromCart(${item.id})" title="Удалить">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                cartContainer.innerHTML = itemsHtml;
            }
            
            // Update totals
            document.getElementById('subtotal').textContent = transaction.subtotal.toFixed(2) + ' ₸';
            document.getElementById('taxAmount').textContent = transaction.tax_amount.toFixed(2) + ' ₸';
            document.getElementById('totalAmount').textContent = transaction.total_amount.toFixed(2) + ' ₸';
            
            // Update discount display
            const discountRow = document.getElementById('discountRow');
            const discountAmount = document.getElementById('discountAmount');
            const removeDiscountBtn = document.getElementById('removeDiscountBtn');
            
            if (transaction.discount_amount && transaction.discount_amount > 0) {
                discountRow.style.display = 'flex';
                discountAmount.textContent = '-' + transaction.discount_amount.toFixed(2) + ' ₸';
                removeDiscountBtn.style.display = 'block';
            } else {
                discountRow.style.display = 'none';
                removeDiscountBtn.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Cart update error:', error);
    }
}

async function clearCart() {
    if (!currentTransaction) {
        return;
    }
    
    if (confirm('Вы уверены, что хотите очистить корзину?')) {
        try {
            // Get current transaction items and remove them
            const response = await fetch('/api/transaction/current');
            const result = await response.json();
            
            if (result.success && result.transaction.items.length > 0) {
                // Remove each item
                for (const item of result.transaction.items) {
                    await fetch('/api/transaction/remove_item', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            item_id: item.id
                        })
                    });
                }
                
                // Воспроизводим звук очистки корзины
                window.posSound && window.posSound.clearCartBeep();
                
                // Update display
                updateCartDisplay();
            }
        } catch (error) {
            console.error('Clear cart error:', error);
            // Fallback to reload if API fails
            location.reload();
        }
    }
}

async function suspendTransaction() {
    if (!currentTransaction) {
        return;
    }
    
    try {
        const response = await fetch('/api/transaction/suspend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Воспроизводим звук приостановки
            window.posSound && window.posSound.suspendBeep();
            alert(result.message);
            location.reload();
        } else {
            window.posSound && window.posSound.errorBeep();
            alert('Ошибка: ' + result.error);
        }
    } catch (error) {
        console.error('Suspend error:', error);
        alert('Ошибка связи с сервером');
    }
}

async function processPayment(paymentMethod) {
    const totalAmountText = document.getElementById('totalAmount').textContent.replace(' ₸', '');
    const totalAmount = parseFloat(totalAmountText);
    
    if (totalAmount <= 0) {
        alert('Корзина пуста');
        return;
    }
    
    let confirmed = false;
    
    if (paymentMethod === 'cash') {
        const cashReceived = prompt(`Оплата наличными\nК оплате: ${totalAmount.toFixed(2)} ₸\n\nВведите сумму, полученную от покупателя:`);
        
        if (cashReceived === null) {
            return; // User cancelled
        }
        
        const receivedAmount = parseFloat(cashReceived);
        
        if (isNaN(receivedAmount) || receivedAmount < totalAmount) {
            alert('Неверная сумма или недостаточно средств');
            return;
        }
        
        const change = receivedAmount - totalAmount;
        if (change > 0) {
            alert(`Сдача: ${change.toFixed(2)} ₸`);
        }
        
        confirmed = true;
    } else if (paymentMethod === 'card') {
        confirmed = confirm(`Оплата картой\nСумма: ${totalAmount.toFixed(2)} ₸\n\nПодтвердите оплату`);
    }
    
    if (!confirmed) {
        return;
    }
    
    const payments = [{
        method: paymentMethod,
        amount: totalAmount
    }];
    
    // Add reference number for card payments
    if (paymentMethod === 'card') {
        payments[0].reference_number = 'CARD_' + Date.now();
    }
    
    try {
        const response = await fetch('/api/transaction/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ payments })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Воспроизводим мелодичный звук успешного завершения
            window.posSound && window.posSound.completeBeep();
            
            alert(`Оплата успешно завершена!\nЧек: ${result.transaction_number}\nСумма: ${result.total_amount.toFixed(2)} ₸`);
            
            // Reset interface
            location.reload();
        } else {
            window.posSound && window.posSound.errorBeep();
            alert('Ошибка оплаты: ' + result.error);
        }
    } catch (error) {
        console.error('Payment error:', error);
        alert('Ошибка связи с сервером');
    }
}

async function removeFromCart(itemId) {
    try {
        const response = await fetch('/api/transaction/remove_item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                item_id: itemId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Воспроизводим звук удаления товара
            window.posSound && window.posSound.removeItemBeep();
            updateCartDisplay();
        } else {
            window.posSound && window.posSound.errorBeep();
            alert('Ошибка удаления товара: ' + result.error);
        }
    } catch (error) {
        console.error('Remove item error:', error);
        alert('Ошибка связи с сервером');
    }
}

// Discount functionality
function toggleDiscountSection() {
    const discountSection = document.getElementById('discountSection');
    const discountBtn = document.getElementById('discountBtn');
    
    if (discountSection.style.display === 'none' || !discountSection.style.display) {
        discountSection.style.display = 'block';
        discountBtn.classList.add('active');
    } else {
        discountSection.style.display = 'none';
        discountBtn.classList.remove('active');
    }
}

async function applyQuickDiscount(value, type) {
    if (!currentTransaction) {
        alert('Сначала начните транзакцию');
        return;
    }
    
    try {
        const response = await fetch('/api/transaction/apply_discount', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: type,
                value: value
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Воспроизводим звук успешного применения скидки
            window.posSound && window.posSound.discountBeep();
            updateCartDisplay();
            showDiscountFeedback(result.message, 'success');
            document.getElementById('removeDiscountBtn').style.display = 'block';
        } else {
            window.posSound && window.posSound.errorBeep();
            showDiscountFeedback(result.error, 'error');
        }
    } catch (error) {
        console.error('Discount error:', error);
        showDiscountFeedback('Ошибка связи с сервером', 'error');
    }
}

async function applyPromoCode() {
    const promoCodeInput = document.getElementById('promoCodeInput');
    const code = promoCodeInput.value.trim().toUpperCase();
    
    if (!code) {
        showPromoCodeFeedback('Введите промокод', 'error');
        return;
    }
    
    if (!currentTransaction) {
        showPromoCodeFeedback('Сначала начните транзакцию', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/transaction/apply_promo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                code: code
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Воспроизводим звук успешного применения промокода
            window.posSound && window.posSound.discountBeep();
            updateCartDisplay();
            showPromoCodeFeedback(result.message, 'success');
            promoCodeInput.value = '';
            document.getElementById('removeDiscountBtn').style.display = 'block';
        } else {
            window.posSound && window.posSound.errorBeep();
            showPromoCodeFeedback(result.error, 'error');
        }
    } catch (error) {
        console.error('Promo code error:', error);
        showPromoCodeFeedback('Ошибка связи с сервером', 'error');
    }
}

async function applyCustomDiscount() {
    const valueInput = document.getElementById('customDiscountValue');
    const typeSelect = document.getElementById('customDiscountType');
    
    const value = parseFloat(valueInput.value);
    const type = typeSelect.value;
    
    if (isNaN(value) || value <= 0) {
        showDiscountFeedback('Введите корректную сумму скидки', 'error');
        return;
    }
    
    if (!currentTransaction) {
        showDiscountFeedback('Сначала начните транзакцию', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/transaction/apply_discount', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: type,
                value: value
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Воспроизводим звук успешного применения кастомной скидки
            window.posSound && window.posSound.discountBeep();
            updateCartDisplay();
            showDiscountFeedback(result.message, 'success');
            valueInput.value = '';
            document.getElementById('removeDiscountBtn').style.display = 'block';
        } else {
            window.posSound && window.posSound.errorBeep();
            showDiscountFeedback(result.error, 'error');
        }
    } catch (error) {
        console.error('Custom discount error:', error);
        showDiscountFeedback('Ошибка связи с сервером', 'error');
    }
}

async function removeDiscount() {
    if (!currentTransaction) {
        return;
    }
    
    try {
        const response = await fetch('/api/transaction/remove_promo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            updateCartDisplay();
            showDiscountFeedback('Скидка удалена', 'success');
            document.getElementById('removeDiscountBtn').style.display = 'none';
        } else {
            showDiscountFeedback(result.error, 'error');
        }
    } catch (error) {
        console.error('Remove discount error:', error);
        showDiscountFeedback('Ошибка связи с сервером', 'error');
    }
}

function showDiscountFeedback(message, type) {
    // Create a simple alert for now
    if (type === 'success') {
        // Show success message briefly
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    } else {
        alert(message);
    }
}

function showPromoCodeFeedback(message, type) {
    const feedbackDiv = document.getElementById('promoCodeFeedback');
    feedbackDiv.textContent = message;
    feedbackDiv.className = type === 'success' ? 'text-success small' : 'text-danger small';
    feedbackDiv.style.display = 'block';
    
    if (type === 'success') {
        setTimeout(() => {
            feedbackDiv.style.display = 'none';
        }, 3000);
    }
}

// Suspended transactions functionality
async function showSuspendedTransactions() {
    try {
        const response = await fetch('/api/suspended_transactions');
        const result = await response.json();
        
        if (result.success) {
            const transactions = result.transactions;
            const modalBody = document.getElementById('suspendedTransactionsBody');
            
            if (transactions.length === 0) {
                modalBody.innerHTML = '<p class="text-muted">Нет отложенных чеков</p>';
            } else {
                let html = '<div class="table-responsive"><table class="table table-hover">';
                html += '<thead><tr><th>№ Чека</th><th>Дата</th><th>Кассир</th><th>Товаров</th><th>Сумма</th><th>Действие</th></tr></thead><tbody>';
                
                transactions.forEach(transaction => {
                    html += `<tr>
                        <td><strong>${transaction.transaction_number}</strong></td>
                        <td>${transaction.created_at}</td>
                        <td>${transaction.cashier_name}</td>
                        <td>${transaction.items_count}</td>
                        <td>${transaction.total_amount.toFixed(2)} ₸</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="restoreTransaction(${transaction.id})">
                                <i class="fas fa-undo me-1"></i>Восстановить
                            </button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                modalBody.innerHTML = html;
            }
            
            new bootstrap.Modal(document.getElementById('suspendedTransactionsModal')).show();
        } else {
            alert('Ошибка загрузки отложенных чеков: ' + result.error);
        }
    } catch (error) {
        console.error('Error loading suspended transactions:', error);
        alert('Ошибка связи с сервером');
    }
}

async function restoreTransaction(transactionId) {
    if (currentTransaction) {
        if (!confirm('У вас есть активная транзакция. Завершите или отложите ее перед восстановлением другой.')) {
            return;
        }
    }
    
    try {
        const response = await fetch('/api/transaction/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                transaction_id: transactionId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            bootstrap.Modal.getInstance(document.getElementById('suspendedTransactionsModal')).hide();
            location.reload(); // Reload to refresh the interface
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (error) {
        console.error('Restore error:', error);
        alert('Ошибка связи с сервером');
    }
}

// Quick Access Panel functionality
let quickAccessVisible = false;

async function toggleQuickAccess() {
    const panel = document.getElementById('quickAccessPanel');
    const button = document.getElementById('toggleQuickAccess');
    
    if (!quickAccessVisible) {
        // Show panel and load products
        panel.style.display = 'block';
        button.classList.remove('btn-outline-success');
        button.classList.add('btn-success');
        quickAccessVisible = true;
        
        await loadQuickAccessProducts();
    } else {
        // Hide panel
        panel.style.display = 'none';
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-success');
        quickAccessVisible = false;
    }
}

async function loadQuickAccessProducts() {
    const container = document.getElementById('quickAccessProducts');
    
    try {
        // Show loading spinner
        container.innerHTML = `
            <div class="col-12 text-center py-3">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                Загрузка популярных товаров...
            </div>`;
        
        const response = await fetch('/api/quick-access-products');
        const data = await response.json();
        
        if (data.success && data.products.length > 0) {
            displayQuickAccessProducts(data.products);
        } else {
            container.innerHTML = `
                <div class="col-12 text-center py-3">
                    <p class="text-muted mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Нет данных о популярных товарах
                    </p>
                    <small class="text-muted">Данные появятся после совершения продаж</small>
                </div>`;
        }
    } catch (error) {
        console.error('Error loading quick access products:', error);
        container.innerHTML = `
            <div class="col-12 text-center py-3">
                <p class="text-danger mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ошибка загрузки популярных товаров
                </p>
            </div>`;
    }
}

function displayQuickAccessProducts(products) {
    const container = document.getElementById('quickAccessProducts');
    
    // Clear container first
    container.innerHTML = '';
    
    products.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.className = 'col-lg-3 col-md-4 col-6';
        
        const quickAccessDiv = document.createElement('div');
        quickAccessDiv.className = 'quick-access-product';
        quickAccessDiv.setAttribute('data-product-id', product.id);
        quickAccessDiv.setAttribute('data-product-name', product.name);
        quickAccessDiv.setAttribute('data-product-price', product.price);
        
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card h-100 shadow-sm border-0 quick-product-card';
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body p-2 text-center';
        
        // Image or icon
        const imageDiv = document.createElement('div');
        imageDiv.className = 'mb-2';
        
        if (product.image_filename) {
            const img = document.createElement('img');
            img.src = `/static/images/products/thumbnails/${product.image_filename}`;
            img.alt = product.name;
            img.className = 'img-fluid rounded';
            img.style.cssText = 'width: 40px; height: 40px; object-fit: cover;';
            imageDiv.appendChild(img);
        } else {
            const icon = document.createElement('i');
            icon.className = 'fas fa-box text-muted';
            icon.style.fontSize = '1.5rem';
            imageDiv.appendChild(icon);
        }
        
        // Product name
        const nameHeader = document.createElement('h6');
        nameHeader.className = 'card-title mb-1';
        nameHeader.style.cssText = 'font-size: 0.8rem; line-height: 1.2;';
        nameHeader.textContent = product.name.length > 25 ? product.name.substring(0, 25) + '...' : product.name;
        
        // Price
        const priceP = document.createElement('p');
        priceP.className = 'card-text mb-1';
        const priceStrong = document.createElement('strong');
        priceStrong.style.fontSize = '0.9rem';
        priceStrong.textContent = `${product.price.toFixed(2)} ₸`;
        priceP.appendChild(priceStrong);
        
        // Stock
        const stockSmall = document.createElement('small');
        stockSmall.className = 'text-muted';
        stockSmall.style.fontSize = '0.7rem';
        stockSmall.textContent = `В наличии: ${product.stock_quantity}`;
        
        // Add elements to card body
        cardBody.appendChild(imageDiv);
        cardBody.appendChild(nameHeader);
        cardBody.appendChild(priceP);
        cardBody.appendChild(stockSmall);
        
        // Recent sales badge
        if (product.recent_sales > 0) {
            const badgeDiv = document.createElement('div');
            badgeDiv.className = 'mt-1';
            
            const badge = document.createElement('span');
            badge.className = 'badge bg-warning text-dark';
            badge.style.fontSize = '0.6rem';
            
            const fireIcon = document.createElement('i');
            fireIcon.className = 'fas fa-fire me-1';
            badge.appendChild(fireIcon);
            badge.appendChild(document.createTextNode(`${product.recent_sales} за неделю`));
            
            badgeDiv.appendChild(badge);
            cardBody.appendChild(badgeDiv);
        }
        
        // Add click handler for adding to cart
        quickAccessDiv.addEventListener('click', function() {
            if (currentTransaction) {
                addToCart(product);
            } else {
                showNotification('Начните новую транзакцию для добавления товаров', 'warning');
            }
        });
        
        // Assemble the card
        cardDiv.appendChild(cardBody);
        quickAccessDiv.appendChild(cardDiv);
        productDiv.appendChild(quickAccessDiv);
        container.appendChild(productDiv);
    });
}

// Звуковая система реализована глобально в base.html как window.posSound
    
    // Инициализация AudioContext при первом пользовательском взаимодействии
    async prime() {
        if (this.audioContext || this.isPrimed) return true;
        
        try {
            const AudioContextClass = window.AudioContext || window.webkitAudioContext;
            if (!AudioContextClass) {
                console.warn('Web Audio API не поддерживается браузером');
                this.soundEnabled = false;
                return false;
            }
            
            this.audioContext = new AudioContextClass();
            
            // Принудительное возобновление контекста
            if (this.audioContext.state === 'suspended') {
                await this.audioContext.resume();
            }
            
            // Воспроизводим беззвучный буфер для "прогрева" системы
            const buffer = this.audioContext.createBuffer(1, 1, 22050);
            const source = this.audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(this.audioContext.destination);
            source.start();
            
            this.initialized = true;
            this.isPrimed = true;
            
            console.log('Звуковая система успешно инициализирована');
            return true;
            
        } catch (e) {
            console.warn('Ошибка инициализации звуковой системы:', e);
            this.soundEnabled = false;
            return false;
        }
    }
    
    // Возобновляем AudioContext при первом взаимодействии
    async ensureAudioContextActive() {
        if (!this.audioContext || !this.soundEnabled) return false;
        
        try {
            if (this.audioContext.state === 'suspended') {
                await this.audioContext.resume();
                console.log('AudioContext возобновлён');
            }
            return this.audioContext.state === 'running';
        } catch (e) {
            console.warn('Не удалось возобновить AudioContext:', e);
            return false;
        }
    }
    
    // Дебаунс для избежания повторных звуков
    shouldPlaySound() {
        const now = Date.now();
        if (now - this.lastBeepTime < 250) return false; // 250мс минимальный интервал
        this.lastBeepTime = now;
        return true;
    }
    
    // Улучшенное воспроизведение тона с ADSR обвязкой
    async playTone(frequency, duration, volume = this.masterVolume) {
        if (!this.soundEnabled || !this.shouldPlaySound()) return;
        
        // Проверяем что система проинициализирована
        if (!this.isPrimed || !this.audioContext) {
            console.warn('Звуковая система не активирована пользователем');
            return;
        }
        
        const isActive = await this.ensureAudioContextActive();
        if (!isActive) return;
        
        try {
            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);
            
            // Настройки звука для POS-среды
            oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
            oscillator.type = 'triangle'; // Более мягкий звук чем square
            
            // ADSR обвязка: быстрая атака, плавное затухание
            const startTime = this.audioContext.currentTime;
            const attackTime = 0.005; // 5мс атака
            const decayTime = duration - 0.05; // Основная часть
            const releaseTime = 0.05; // 50мс затухание
            
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(volume, startTime + attackTime);
            gainNode.gain.linearRampToValueAtTime(volume * 0.7, startTime + attackTime + decayTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        } catch (e) {
            console.warn('Ошибка воспроизведения звука:', e);
        }
    }
    
    // Оптимизированные звуки для POS (согласно рекомендациям архитектора)
    successBeep() {
        this.playTone(1200, 0.08); // Высокий чистый тон успеха
    }
    
    // Ошибка сканирования - два коротких низких тона
    errorBeep() {
        this.playTone(300, 0.12);
        setTimeout(() => this.playTone(350, 0.12), 160);
    }
    
    // Предупреждение (низкий остаток) - два средних тона с паузой
    warningBeep() {
        this.playTone(500, 0.08);
        setTimeout(() => this.playTone(500, 0.08), 160);
    }
    
    // Добавление товара в корзину - короткий приятный тон
    addItemBeep() {
        this.playTone(1400, 0.06); // Высокий короткий сигнал
    }
    
    // Удаление товара из корзины - мягкий нисходящий тон
    removeItemBeep() {
        this.playTone(800, 0.08); // Средний тон
    }
    
    // Очистка корзины - двойной мягкий тон
    clearCartBeep() {
        this.playTone(600, 0.1);
        setTimeout(() => this.playTone(400, 0.1), 120);
    }
    
    // Приостановка транзакции - нейтральный клик
    suspendBeep() {
        this.playTone(1000, 0.04); // Очень короткий клик
    }
    
    // Применение скидки - приятный тон
    discountBeep() {
        this.playTone(1200, 0.1);
    }
    
    // Завершение транзакции - восходящая мелодия
    completeBeep() {
        this.playTone(800, 0.12);
        setTimeout(() => this.playTone(1000, 0.12), 120);
        setTimeout(() => this.playTone(1300, 0.18), 240);
    }
    
    // Переключение звука вкл/выкл с сохранением в localStorage
    toggleSound() {
        this.soundEnabled = !this.soundEnabled;
        this.saveSoundPreference();
        this.updateSoundButton();
        
        const status = this.soundEnabled ? 'включены' : 'выключены';
        showNotification(`Звуковые уведомления ${status}`, 'info', 2000);
        
        // Тестовый звук при включении
        if (this.soundEnabled) {
            setTimeout(() => this.addItemBeep(), 200);
        }
        
        return this.soundEnabled;
    }
    
    // Применение сохранённых настроек к UI при загрузке
    applySettingsToUI() {
        this.updateSoundButton();
    }
    
    // Обновление иконки кнопки звука в UI
    updateSoundButton() {
        const soundBtn = document.getElementById('toggleSoundBtn');
        if (soundBtn) {
            const icon = soundBtn.querySelector('i');
            if (icon) {
                icon.className = this.soundEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
            }
            soundBtn.title = this.soundEnabled ? 'Выключить звук' : 'Включить звук';
            soundBtn.classList.toggle('btn-outline-secondary', this.soundEnabled);
            soundBtn.classList.toggle('btn-outline-danger', !this.soundEnabled);
        }
    }
}

// Звуковая система загружена глобально из base.html как window.posSound

// Горячие клавиши для кассиров (F1-F12)
function setupHotkeys() {
    // Показать справку по горячим клавишам
    function showHotkeysHelp() {
        const helpMessage = `
        <div class="hotkeys-help">
            <h5><i class="fas fa-keyboard me-2"></i>Горячие клавиши кассира</h5>
            <div class="row">
                <div class="col-6">
                    <p><kbd>F1</kbd> - Новая транзакция</p>
                    <p><kbd>F2</kbd> - Завершить транзакцию</p>
                    <p><kbd>F3</kbd> - Отложить транзакцию</p>
                    <p><kbd>F4</kbd> - Популярные товары</p>
                    <p><kbd>F5</kbd> - Сканер штрих-кодов</p>
                    <p><kbd>F6</kbd> - Отложенные чеки</p>
                </div>
                <div class="col-6">
                    <p><kbd>F7</kbd> - Применить скидку</p>
                    <p><kbd>F8</kbd> - Удалить товар</p>
                    <p><kbd>F9</kbd> - Фокус на поиск</p>
                    <p><kbd>F10</kbd> - Перейти к отчетам</p>
                    <p><kbd>F11</kbd> - Переключить язык</p>
                    <p><kbd>F12</kbd> - Эта справка</p>
                    <p><kbd>Ctrl+M</kbd> - Вкл/выкл звук</p>
                </div>
            </div>
        </div>`;
        showNotification(helpMessage, 'info', 8000);
    }
    
    // Обработчик горячих клавиш
    document.addEventListener('keydown', function(event) {
        // Игнорируем если фокус в input или textarea
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
            // Исключение для F-клавиш при работе с поиском
            if (event.key === 'F9') {
                event.preventDefault();
                document.getElementById('productSearch').focus();
                return;
            }
            if (event.key.startsWith('F') && event.key !== 'F9') {
                return; // Позволяем другие F-клавиши работать даже в полях
            }
        }
        
        switch(event.key) {
            case 'F1':
                event.preventDefault();
                if (currentTransaction) {
                    showNotification('Завершите текущую транзакцию перед началом новой', 'warning');
                } else {
                    startTransaction();
                }
                break;
                
            case 'F2':
                event.preventDefault();
                if (currentTransaction && currentTransaction.items.length > 0) {
                    document.getElementById('checkoutBtn').click();
                } else {
                    showNotification('Нет товаров в корзине для завершения', 'warning');
                }
                break;
                
            case 'F3':
                event.preventDefault();
                if (currentTransaction && currentTransaction.items.length > 0) {
                    suspendTransaction();
                } else {
                    showNotification('Нет активной транзакции для отложения', 'warning');
                }
                break;
                
            case 'F4':
                event.preventDefault();
                const quickAccessBtn = document.getElementById('toggleQuickAccess');
                if (quickAccessBtn) {
                    quickAccessBtn.click();
                }
                break;
                
            case 'F5':
                event.preventDefault();
                const scannerBtn = document.getElementById('toggleBarcodeScanner');
                if (scannerBtn) {
                    scannerBtn.click();
                }
                break;
                
            case 'F6':
                event.preventDefault();
                const suspendedBtn = document.getElementById('showSuspendedBtn');
                if (suspendedBtn) {
                    suspendedBtn.click();
                } else {
                    showSuspendedTransactions();
                }
                break;
                
            case 'F7':
                event.preventDefault();
                if (currentTransaction && currentTransaction.items.length > 0) {
                    // Показываем поле для ввода скидки
                    const discount = prompt('Введите размер скидки (% или ₸):');
                    if (discount) {
                        applyDiscount(discount);
                    }
                } else {
                    showNotification('Добавьте товары в корзину для применения скидки', 'warning');
                }
                break;
                
            case 'F8':
                event.preventDefault();
                if (currentTransaction && currentTransaction.items.length > 0) {
                    // Удаляем последний добавленный товар
                    const lastItem = currentTransaction.items[currentTransaction.items.length - 1];
                    if (lastItem) {
                        removeFromCart(lastItem.product_id);
                    }
                } else {
                    showNotification('Нет товаров для удаления', 'warning');
                }
                break;
                
            case 'F9':
                event.preventDefault();
                const searchInput = document.getElementById('productSearch');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
                break;
                
            case 'F10':
                event.preventDefault();
                window.location.href = '/reports';
                break;
                
            case 'F11':
                event.preventDefault();
                // Переключение языка
                const currentLang = document.documentElement.lang === 'kk' ? 'ru' : 'kk';
                window.location.href = `/set_language/${currentLang}`;
                break;
                
            case 'F12':
                event.preventDefault();
                showHotkeysHelp();
                break;
        }
        
        // Комбинация Ctrl+M для переключения звука
        if (event.ctrlKey && event.key === 'm') {
            event.preventDefault();
            if (window.posSound) {
                window.posSound.toggleSound();
            }
        }
    });
    
    // Показываем уведомление о доступности горячих клавиш при загрузке
    setTimeout(() => {
        showNotification('<i class="fas fa-keyboard me-2"></i>Совет: Используйте клавишу F12 для просмотра горячих клавиш', 'info', 4000);
    }, 2000);
}

// Initialize event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for quick access and suspended transactions  
    const quickAccessBtn = document.getElementById('toggleQuickAccess');
    const suspendedBtn = document.getElementById('showSuspendedBtn');
    
    if (quickAccessBtn) {
        quickAccessBtn.addEventListener('click', toggleQuickAccess);
    }
    
    if (suspendedBtn) {
        suspendedBtn.addEventListener('click', showSuspendedTransactions);
    }
    
    // Инициализируем горячие клавиши  
    setupHotkeys();
    
    // Звуковая система уже инициализирована глобально в base.html
    // Все звуковые вызовы используют window.posSound
});

</script>

<!-- Suspended Transactions Modal -->
<div class="modal fade" id="suspendedTransactionsModal" tabindex="-1" aria-labelledby="suspendedTransactionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="suspendedTransactionsModalLabel">
                    <i class="fas fa-history me-2"></i>Отложенные чеки
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="suspendedTransactionsBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}