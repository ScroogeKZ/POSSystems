{% extends "base.html" %}

{% block title %}Кассалық бөлім / Касса - POS Жүйесі{% endblock %}

{% block content %}
<div class="modern-pos-interface">
    <div class="container-fluid">
        <div class="row h-100">
            <!-- Left Panel - Product Search -->
            <div class="col-lg-6 search-panel">
                <div class="search-header">
                    <h4>Тауарларды іздеу / Поиск товаров</h4>
                </div>
                
                <div class="search-controls">
                    <div class="row g-3">
                        <div class="col-8">
                            <input type="text" id="productSearch" class="form-control form-control-lg" 
                                   placeholder="Тауар атауын немесе артикулын енгізіңіз..." autocomplete="off">
                        </div>
                        <div class="col-4">
                            <select id="categoryFilter" class="form-select form-select-lg">
                                <option value="">Все категории</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="searchResults" class="search-results mt-3"></div>
            </div>

            <!-- Right Panel - Transaction & Payment -->
            <div class="col-lg-6 transaction-panel">
                <!-- Transaction Header -->
                <div class="transaction-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>Чек / Транзакция</h4>
                        <div id="transactionInfo" style="display: none;">
                            <span class="badge bg-primary fs-6" id="transactionNumber"></span>
                        </div>
                    </div>
                </div>

                <!-- Transaction Items -->
                <div class="transaction-items">
                    <div class="items-header">
                        <div class="row fw-bold text-muted small">
                            <div class="col-5">ТОВАР</div>
                            <div class="col-2 text-center">КОЛ.</div>
                            <div class="col-2 text-end">ЦЕНА</div>
                            <div class="col-2 text-end">СУММА</div>
                            <div class="col-1"></div>
                        </div>
                    </div>
                    
                    <div id="cartItems" class="items-list">
                        <div class="empty-cart">
                            <p class="text-muted text-center py-5">
                                <i class="fas fa-shopping-cart fa-3x mb-3"></i><br>
                                Корзина пуста<br>
                                <small>Добавьте товары для начала продажи</small>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="payment-section">
                    <!-- Totals Display -->
                    <div class="totals-display">
                        <div class="d-flex justify-content-between">
                            <span>Подитог:</span>
                            <span id="subtotal">0.00 ₸</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>НДС (12%):</span>
                            <span id="taxAmount">0.00 ₸</span>
                        </div>
                        <div class="total-amount">
                            <div class="d-flex justify-content-between">
                                <span>ИТОГО:</span>
                                <span id="totalAmount">0.00 ₸</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button id="startTransaction" class="btn btn-start">
                            <i class="fas fa-play me-2"></i>Начать продажу
                        </button>
                        
                        <div id="transactionActions" style="display: none;">
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <button id="suspendTransaction" class="btn btn-secondary w-100">
                                        <i class="fas fa-pause me-2"></i>Отложить
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button id="clearCart" class="btn btn-outline-danger w-100">
                                        <i class="fas fa-trash me-2"></i>Очистить
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Payment Methods -->
                            <div class="payment-methods">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <button id="cashPaymentBtn" class="btn btn-payment btn-cash w-100">
                                            <i class="fas fa-money-bill-wave mb-2"></i><br>
                                            <span>Наличные</span>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button id="cardPaymentBtn" class="btn btn-payment btn-card w-100">
                                            <i class="fas fa-credit-card mb-2"></i><br>
                                            <span>Карта</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// POS JavaScript functionality will be added here
let currentTransaction = null;
let cart = [];

// Initialize POS interface
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
});

function initializeEventListeners() {
    // Product search
    const searchInput = document.getElementById('productSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    
    searchInput.addEventListener('input', debounce(searchProducts, 300));
    categoryFilter.addEventListener('change', searchProducts);
    
    // Transaction actions
    document.getElementById('startTransaction').addEventListener('click', startNewTransaction);
    document.getElementById('clearCart').addEventListener('click', clearCart);
    document.getElementById('suspendTransaction').addEventListener('click', suspendTransaction);
    
    // Payment buttons
    document.getElementById('cashPaymentBtn').addEventListener('click', () => processPayment('cash'));
    document.getElementById('cardPaymentBtn').addEventListener('click', () => processPayment('card'));
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function searchProducts() {
    const query = document.getElementById('productSearch').value;
    const categoryId = document.getElementById('categoryFilter').value;
    
    if (query.length < 2 && !categoryId) {
        document.getElementById('searchResults').innerHTML = '';
        return;
    }
    
    try {
        const params = new URLSearchParams();
        if (query) params.append('q', query);
        if (categoryId) params.append('category_id', categoryId);
        
        const response = await fetch(`/api/products/search?${params}`);
        const products = await response.json();
        
        displaySearchResults(products);
    } catch (error) {
        console.error('Search error:', error);
    }
}

function displaySearchResults(products) {
    const resultsContainer = document.getElementById('searchResults');
    
    if (products.length === 0) {
        resultsContainer.innerHTML = '<p class="text-muted">Тауарлар табылмады / Товары не найдены</p>';
        return;
    }
    
    const html = products.map(product => `
        <div class="product-card card mb-2" data-product-id="${product.id}" data-product-name="${product.name.replace(/"/g, '&quot;')}" data-product-price="${product.price}" onclick="addToCartSafe(this)">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-8">
                        <h6 class="card-title mb-1">${product.name}</h6>
                        <small class="text-muted">Артикул: ${product.sku}</small>
                    </div>
                    <div class="col-4 text-end">
                        <strong>${product.price.toFixed(2)} ₸</strong>
                        <br>
                        <small class="text-muted">На складе: ${product.stock_quantity} ${product.unit_type}</small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    resultsContainer.innerHTML = html;
}

async function startNewTransaction() {
    try {
        const response = await fetch('/api/transaction/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cashier_name: 'Кассир'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentTransaction = result;
            document.getElementById('transactionNumber').textContent = result.transaction_number;
            document.getElementById('transactionInfo').style.display = 'block';
            document.getElementById('startTransaction').style.display = 'none';
            document.getElementById('transactionActions').style.display = 'block';
        } else {
            alert('Ошибка создания транзакции: ' + result.error);
        }
    } catch (error) {
        console.error('Transaction start error:', error);
        alert('Ошибка связи с сервером');
    }
}

function addToCartSafe(element) {
    const productId = element.dataset.productId;
    const productName = element.dataset.productName;
    const price = parseFloat(element.dataset.productPrice);
    addToCart(parseInt(productId), productName, price);
}

async function addToCart(productId, productName, price) {
    if (!currentTransaction) {
        alert('Сначала начните новую продажу');
        return;
    }
    
    try {
        const response = await fetch('/api/transaction/add_item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: 1
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            updateCartDisplay();
        } else {
            alert('Ошибка добавления товара: ' + result.error);
        }
    } catch (error) {
        console.error('Add to cart error:', error);
        alert('Ошибка связи с сервером');
    }
}

async function updateCartDisplay() {
    try {
        const response = await fetch('/api/transaction/current');
        const result = await response.json();
        
        if (result.success) {
            const transaction = result.transaction;
            const cartContainer = document.getElementById('cartItems');
            
            if (transaction.items.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-cart">
                        <p class="text-muted text-center py-5">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i><br>
                            Корзина пуста<br>
                            <small>Добавьте товары для начала продажи</small>
                        </p>
                    </div>
                `;
            } else {
                const itemsHtml = transaction.items.map(item => `
                    <div class="cart-item">
                        <div class="row align-items-center">
                            <div class="col-5">
                                <div class="fw-bold">${item.product_name}</div>
                                <small class="text-muted">${item.sku}</small>
                            </div>
                            <div class="col-2 text-center">
                                <span class="fw-bold">${item.quantity}</span>
                            </div>
                            <div class="col-2 text-end">
                                <span>${item.unit_price.toFixed(2)} ₸</span>
                            </div>
                            <div class="col-2 text-end">
                                <span class="fw-bold">${item.total_price.toFixed(2)} ₸</span>
                            </div>
                            <div class="col-1 text-end">
                                <button class="btn btn-outline-danger btn-sm" onclick="removeFromCart(${item.id})" title="Удалить">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                cartContainer.innerHTML = itemsHtml;
            }
            
            // Update totals
            document.getElementById('subtotal').textContent = transaction.subtotal.toFixed(2) + ' ₸';
            document.getElementById('taxAmount').textContent = transaction.tax_amount.toFixed(2) + ' ₸';
            document.getElementById('totalAmount').textContent = transaction.total_amount.toFixed(2) + ' ₸';
        }
    } catch (error) {
        console.error('Cart update error:', error);
    }
}

async function clearCart() {
    if (!currentTransaction) {
        return;
    }
    
    if (confirm('Вы уверены, что хотите очистить корзину?')) {
        try {
            // Get current transaction items and remove them
            const response = await fetch('/api/transaction/current');
            const result = await response.json();
            
            if (result.success && result.transaction.items.length > 0) {
                // Remove each item
                for (const item of result.transaction.items) {
                    await fetch('/api/transaction/remove_item', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            item_id: item.id
                        })
                    });
                }
                
                // Update display
                updateCartDisplay();
            }
        } catch (error) {
            console.error('Clear cart error:', error);
            // Fallback to reload if API fails
            location.reload();
        }
    }
}

async function suspendTransaction() {
    if (!currentTransaction) {
        return;
    }
    
    try {
        const response = await fetch('/api/transaction/suspend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (error) {
        console.error('Suspend error:', error);
        alert('Ошибка связи с сервером');
    }
}

async function processPayment(paymentMethod) {
    const totalAmountText = document.getElementById('totalAmount').textContent.replace(' ₸', '');
    const totalAmount = parseFloat(totalAmountText);
    
    if (totalAmount <= 0) {
        alert('Корзина пуста');
        return;
    }
    
    let confirmed = false;
    
    if (paymentMethod === 'cash') {
        const cashReceived = prompt(`Оплата наличными\nК оплате: ${totalAmount.toFixed(2)} ₸\n\nВведите сумму, полученную от покупателя:`);
        
        if (cashReceived === null) {
            return; // User cancelled
        }
        
        const receivedAmount = parseFloat(cashReceived);
        
        if (isNaN(receivedAmount) || receivedAmount < totalAmount) {
            alert('Неверная сумма или недостаточно средств');
            return;
        }
        
        const change = receivedAmount - totalAmount;
        if (change > 0) {
            alert(`Сдача: ${change.toFixed(2)} ₸`);
        }
        
        confirmed = true;
    } else if (paymentMethod === 'card') {
        confirmed = confirm(`Оплата картой\nСумма: ${totalAmount.toFixed(2)} ₸\n\nПодтвердите оплату`);
    }
    
    if (!confirmed) {
        return;
    }
    
    const payments = [{
        method: paymentMethod,
        amount: totalAmount
    }];
    
    // Add reference number for card payments
    if (paymentMethod === 'card') {
        payments[0].reference_number = 'CARD_' + Date.now();
    }
    
    try {
        const response = await fetch('/api/transaction/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ payments })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Оплата успешно завершена!\nЧек: ${result.transaction_number}\nСумма: ${result.total_amount.toFixed(2)} ₸`);
            
            // Reset interface
            location.reload();
        } else {
            alert('Ошибка оплаты: ' + result.error);
        }
    } catch (error) {
        console.error('Payment error:', error);
        alert('Ошибка связи с сервером');
    }
}

async function removeFromCart(itemId) {
    try {
        const response = await fetch('/api/transaction/remove_item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                item_id: itemId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            updateCartDisplay();
        } else {
            alert('Ошибка удаления товара: ' + result.error);
        }
    } catch (error) {
        console.error('Remove item error:', error);
        alert('Ошибка связи с сервером');
    }
}

</script>
{% endblock %}